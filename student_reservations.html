<!DOCTYPE html>
<html lang="en">
<head>
    <title>Student reservations</title>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css.css">
    <script type="module" src="API.js"></script>
</head>

<body>
    <div class="content">
        <h1>Reserve Books</h1>

        <div class="book-sections">

            <div class="borrowed-books">
                <h2 id="h_personal">Your bookItems:</h2>
                <table id="reservationsBorrowingsTable" class="internal-table" data-sort-order="asc">
                    <thead>
                        <tr>
                            <th width="5%"><label class="pointy" onclick="sort_by_column('reservationsBorrowingsTable', 0)">id</label></th>
                            <th width="25%"><label class="pointy" onclick="sort_by_column('reservationsBorrowingsTable', 1)">Title</label></th>
                            <th width="15%"><label class="pointy" onclick="sort_by_column('reservationsBorrowingsTable', 2)">Author</label></th>
                            <th width="15%"><label class="pointy" onclick="sort_by_column('reservationsBorrowingsTable', 3)">Category</label></th>
                            <th width="10%"><label class="pointy" onclick="sort_by_column('reservationsBorrowingsTable', 4)">Languages</label></th>
                            <th width="10%"><label class="pointy" onclick="sort_by_column('reservationsBorrowingsTable', 5)">ean</label></th>
                            <th width="13%"><label class="pointy" onclick="sort_by_column('reservationsBorrowingsTable', 6)">Status</label></th>
                            <th>Cancel?</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsBorrowingsContents">
                        <!--
                        <tr data-id="1000">
                            <td>1000</td>
                            <td>123456789</td>
                            <td>J.K. Rowling</td>
                            <td>Harry Potter and the Sorcerer's Stone</td>
                            <td>Fantasy</td>
                            <td>In possession</td>
                            <td>-</td>
                        </tr>
                        <tr data-id="2000">
                            <td>2000</td>
                            <td>123456783</td>
                            <td>George Orwell</td>
                            <td>1984</td>
                            <td>Dystopian</td>
                            <td>Reserved</td>
                            <td>
                                <label><input type="checkbox">Cancel Reservation</label>
                            </td>
                        </tr>
                        <tr data-id="3000">
                            <td>3000</td>
                            <td>234567890</td>
                            <td>J.R.R. Tolkien</td>
                            <td>Hobbit</td>
                            <td>Fantasy</td>
                            <td>In possession</td>
                            <td>-</td>
                        </tr>
                        -->
                    </tbody>
                </table>
            </div>

            <div class="available-books">
                <h2 id="h_available">Available Books</h2>
                <table id="availableBooksTable" class="internal-table" data-sort-order="asc">
                    <thead>
                        <tr>
                            <th width="5%"><label class="pointy" onclick="sort_by_column('availableBooksTable', 0)">id</label></th>
                            <th width="25%"><label class="pointy" onclick="sort_by_column('availableBooksTable', 1)">Title</label></th>
                            <th width="15%"><label class="pointy" onclick="sort_by_column('availableBooksTable', 2)">Author</label></th>
                            <th width="20%"><label class="pointy" onclick="sort_by_column('availableBooksTable', 3)">Category</label></th>
                            <th width="10%"><label class="pointy" onclick="sort_by_column('availableBooksTable', 4)">Languages</label></th>
                            <th width="13%"><label class="pointy" onclick="sort_by_column('availableBooksTable', 5)">Status</label></th>
                            <th>Reserve?</th>
                        </tr>
                    </thead>
                    <tbody id="availableBooksContents">
                        <!--
                            <tr data-id="1000">
                                <td>1000</td>
                                <td>123456789</td>
                                <td>J.K. Rowling</td>
                                <td>Harry Potter and the Sorcerer's Stone</td>
                                <td>Fantasy</td>
                                <td>Available</td>
                                <td>
                                    <label><input type="checkbox">Reserve</label>
                                </td>
                            </tr>
                            <tr data-id="2000">
                                <td>2000</td>
                                <td>123456783</td>
                                <td>George Orwell</td>
                                <td>1984</td>
                                <td>Dystopian</td>
                                <td>No free copies available</td>
                                <td>
                                    <label><input type="checkbox">Reserve</label>
                                </td>
                            </tr>
                            <tr data-id="3000">
                                <td>3000</td>
                                <td>234567890</td>
                                <td>J.R.R. Tolkien</td>
                                <td>Hobbit</td>
                                <td>Fantasy</td>
                                <td>Unavailable</td>
                                <td>
                                    <label><input type="checkbox" disabled>Reserve</label>
                                </td>
                            </tr>
                            -->
                    </tbody>
                </table>
            </div>

            <button onclick="changeReservations(); populate_books()">Save</button>
        </div>

    </div>
    <button onclick="window.location.href='student.html'" id="backBtn">Back</button>



    <!--Scripts-->
    <script type="module">
        import FrontEndAPI from './API.js';
        var API = new FrontEndAPI('https://127.0.0.1:3000');

        //done
        window.onload = populate_books;
        window.populate_books = populate_books;
        function populate_books() {
            try {
                populate_your_ReservationsBorrowings();
                populate_available_Books();
            } catch (err) {
                console.error("Books fetch failed:", err);
                document.write("Books couldn't load.");
            }
        }

        //done
        function populate_your_ReservationsBorrowings() {

            document.getElementById("h_personal").innerHTML = '';
            document.getElementById("reservationsBorrowingsContents").innerHTML = '';

            let inside = '';

            //add student's borrowings & reservations data here
            API.getCurrentUser().then(student => {

                //add borrowings onto page
                API.getMany("Borrowings", { studentId: student.id }, [0, 0]).then(response => {
                    //response = all borrowings of student
                    response.data.items.forEach(borrowing => {
                        inside += `
                        <tr id="mybook_{book_id_TODO}_${borrowing.bookItemEan}">
                            <td>?id</td>
                            <td>?title</td>
                            <td>?author</td>
                            <td>?category</td>
                            <td>?languages</td>
                            <td>${borrowing.bookItemEan}</td>
                            <td>In possession since: ${formatDate(borrowing.borrowingDate)}</td>
                            <td>-</td>
                        </tr>
                        `;
                    });

                    document.getElementById("h_personal").innerHTML += (" " + response.data.totalAmount + " borrowed;");
                    document.getElementById("reservationsBorrowingsContents").innerHTML += inside;

                }).catch(err => {
                    console.error("Borrowings fetch failed:", err);
                    document.write("Borrowings couldn't load.");
                });

                //add reservations onto page
                API.getMany("Reservations", { studentId: student.id, status: "active" }, [0, 0]).then(response => {
                    //response = all reservations of student
                    response.data.items.forEach(reservation => {
                        inside += `
                            <tr id="mybook_${reservation.bookId}">
                                <td>${reservation.bookId}</td>
                                <td>?title</td>
                                <td>?author</td>
                                <td>?category</td>
                                <td>?languages</td>
                                <td>-</td>
                                <td>Reserved since: ${formatDate(reservation.date)}</td>
                                <td><input type="checkbox" name="cancelReservation_checkbox" value="${reservation.id}"></td>
                            </tr>
                            `;
                    });
                    document.getElementById("h_personal").innerHTML += (" " + response.data.totalAmount + " reserved;");
                    document.getElementById("reservationsBorrowingsContents").innerHTML += inside;
                }).catch(err => {
                    console.error("Reservations fetch failed:", err);
                    document.write("Reservations couldn't load.");
                });
            
            });
        }

        //TODO - print the ignored values & add info about available positions (getOne bookItem (id))
        function populate_available_Books() {

            document.getElementById("availableBooksContents").innerHTML = '';
            document.getElementById("h_available").innerHTML = '';

            API.getMany("Books", {}, [0, 0]).then(response => {

                    let inside = '';
                    response.data.items.forEach(book => {
                        inside += `
                            <tr id="book_${book.id}">
                                <td>${book.id}</td>
                                <td>${book.title}</td>
                                <td>?author</td>
                                <td>?category</td>
                                <td>?lang</td>
                                <td>?status</td>
                                <td><input type="checkbox" name="reserveBook_checkbox" value="${book.id}"></td>
                            </tr>
                        `;
                    });
                    document.getElementById("availableBooksContents").innerHTML = inside;
                    document.getElementById("h_available").innerHTML += " (" + response.data.totalAmount + " titles)";

                }).catch(err => {
                    console.error("Books fetch failed:", err);
                    document.write("Books couldn't load.");
                });
        }


        //TODO - implement sorting
        function sortByColumn(column) {

        }


        //done
        window.changeReservations = changeReservations;
        function changeReservations() {
            try {
                cancelReservations();
                makeReservations();
            } catch (err) {
                console.error("Reservations change failed:", err);
                document.write("Reservations change failed.");
            }
        }

        //done
        function cancelReservations() {
            var cancelCheckboxes = document.getElementsByName('cancelReservation_checkbox');
            var cancelCheckboxesChecked = [];

            for (var checkboxCancel of cancelCheckboxes) {
                if (checkboxCancel.checked)
                    cancelCheckboxesChecked.push(checkboxCancel); //construct array of checked
            }

            if (!(cancelCheckboxesChecked.length > 0)) return;

            //cancel chosen reservations
            for (var checkboxCancel of cancelCheckboxesChecked) { //go through all checked and make reservations

                API.cancelReservation(Number(checkboxCancel.value)).then(response => { //?
                    //document.body.append("rezerwacja usunieta || ");
                }).catch(err => {
                    console.error("Reservation cancel with id " + checkboxCancel.value + " failed:", err);
                    document.write("Reservation cancel with id " + checkboxCancel.value + " failed:");
                });
            }
        }

        //done
        function makeReservations() {
            var reserveCheckboxes = document.getElementsByName('reserveBook_checkbox');
            var reserveCheckboxesChecked = [];

            for (var checkboxReserve of reserveCheckboxes) {
                if (checkboxReserve.checked)
                    reserveCheckboxesChecked.push(checkboxReserve); //construct array of checked
            }

            if (!(reserveCheckboxesChecked.length > 0)) return;

            //make reservations
            API.getCurrentUser().then(student => {

                for (var checkboxReserve of reserveCheckboxesChecked) { //go through all checked and make reservations

                    API.reserveBook(student.id, Number(checkboxReserve.value)).then(response => { //?
                        //document.body.append("rezerwacja udana || ");
                    }).catch(err => {
                        console.error("Reservation of book id " + checkboxReserve.value + " failed:", err);
                        document.write("Reservation of book id " + checkboxReserve.value + " failed:");
                    });
                }
            });
        }

        
        //done
        window.sort_by_column = sort_by_column;
        function sort_by_column(tableId, columnNr) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Determine if we're sorting ascending or descending
            const isAscending = table.getAttribute('data-sort-order') === 'asc';
            const direction = isAscending ? 1 : -1;

            // Sort rows by the content of the cells in the specified column
            const sortedRows = rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[columnNr].innerText.trim();
                const cellB = rowB.cells[columnNr].innerText.trim();

                // If the content is numeric, sort as numbers
                if (!isNaN(cellA) && !isNaN(cellB)) {
                    return direction * (Number(cellA) - Number(cellB));
                }
                // Otherwise, sort as strings
                return direction * cellA.localeCompare(cellB);
            });

            // Remove existing rows
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }

            // Append sorted rows back to the table
            sortedRows.forEach(row => tbody.appendChild(row));

            // Toggle the sort order for the next click
            table.setAttribute('data-sort-order', isAscending ? 'desc' : 'asc');
        }

        // yyyy/mm/dd, hh:mm
        function formatDate(date) {
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}, ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

    </script>

</body>
</html>