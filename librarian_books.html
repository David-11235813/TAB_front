<!DOCTYPE html>
<html lang="en">
<head>
    <title>Manage Books</title>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css.css">
    <script type="module" src="API.js"></script>
</head>

<body>
    <div class="content">
        <h1 id="h">Manage Books</h1>

        <div class="books-list">
            <table id="bookItemsTable" class="internal-table">
                <thead>
                    <tr>
                        <th width="3%">id</th>
                        <th width="5%">ean</th>
                        <th width="10%">ISBN</th>
                        <th width="25%">Title</th>
                        <th width="5%">Lang id</th>
                        <th width="5%">Location id</th>
                        <th width="20%">Remarks</th>
                        <th width="8%">Borrowed?</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="bookItemsContents">
                        
                </tbody>
            </table>
        </div>

        <div class="editable">
            <div id="slot1" contenteditable="true" style="max-width: 65px;"></div>
            <div id="slot2" contenteditable="true" style="max-width: 65px;"></div>
            <div id="slot3" contenteditable="true" style="max-width: 160px;"></div>
            <div id="slot4" contenteditable="true"></div>
            <div id="slot5" contenteditable="true" style="max-width: 50px;"></div>
            <div id="slot6" contenteditable="true" style="max-width: 50px;"></div>
            <div id="slot7" contenteditable="true"></div>
            <div id="slot8" contenteditable="true" style="max-width: 70px;"></div>

            <div style="all: unset; max-width:10px;">
                <button class=smallEditButton onclick="pasteSlots()">paste</button>
                <button class=smallEditButton onclick="clearSlots()">clear</button>
            </div>
        </div>


        <div class="buttons">
            <button onclick="addNewBookItem()" class="bottomleft1" style="background-color: dimgray;">Add new BookItem (ignore selected)</button>
            <button onclick="modifySelectedBookItem()" class="bottomleft2" style="background-color: dimgray;">Modify selected Book</button>
            <button onclick="removeSelectedBookItem()" class="bottomleft3" style="background-color: dimgray;">Remove selected Book</button>
        </div>
    </div>
    <button onclick="window.location.href='librarian.html'" id="backBtn">Back</button>




    <!--Scripts-->
    <script type="module">
        import FrontEndAPI from './API.js';
        var API = new FrontEndAPI('https://127.0.0.1:3000');


        window.onload = populate_book_items;
        window.populate_book_items = populate_book_items;
        function populate_book_items() {

            //add info abt authors
            API.getMany("BookItems", {}, [0, 0])
                .then(response => {

                    var inside = '';
                    response.data.items.forEach(bItem => {
                        inside += `
                        <tr id="bItem_${bItem.ean}">
	                        <td>${bItem.book_id}</td>
	                        <td>${bItem.ean}</td>
	                        <td>${bItem.ISBN}</td>
	                        <td>${bItem.book_title}</td>
	                        <td>${bItem.language_id}</td>
	                        <td>${bItem.location_id}</td>
	                        <td>${bItem.remarks}</td>
	                        <td>${bItem.isBorrowed}</td>
	                        <td>
                                <button class="smallButton" id="bItem_${bItem.ean}_button" onclick="selectBookItem('bItem_${bItem.ean}')">select</button>
                            </td>
                        </tr>
                    `;
                    });
                    document.getElementById("bookItemsContents").innerHTML = inside;
                    document.getElementById("h").innerHTML = "Manage Books (" + response.data.totalAmount + " items registered)";

                }).catch(err => {
                    console.error("BookItems fetch failed:", err);
                    document.write("BookItems couldn't load.");
                });
        }


        let selected_row_id = "";

        //done
        window.selectBookItem = selectBookItem;
        function selectBookItem(row_id) {

            //clicked 'unselect'
            if (selected_row_id === row_id) {
                document.getElementById(selected_row_id).setAttribute("style", ""); //row
                document.getElementById(selected_row_id + "_button").setAttribute("class", "smallButton"); //button
                document.getElementById(selected_row_id + "_button").innerHTML = "select";
                selected_row_id = "";
                return;
            }

            //unselect the previous row
            if (selected_row_id != "") {
                document.getElementById(selected_row_id).setAttribute("style", ""); //row
                document.getElementById(selected_row_id + "_button").setAttribute("class", "smallButton"); //button
                document.getElementById(selected_row_id + "_button").innerHTML = "select";
            }

            selected_row_id = row_id;

            //highlight selected row and change button appearence
            document.getElementById(selected_row_id).setAttribute("style", "background: darkgreen;");
            document.getElementById(selected_row_id + "_button").setAttribute("class", "smallRedButton");
            document.getElementById(selected_row_id + "_button").innerHTML = "unselect";
        }

        //done
        window.clearSlots = clearSlots;
        function clearSlots() {
            for (let i = 1; i <= 8; i++) {
                document.getElementById("slot" + i).innerHTML = "";
            }
        }

        //done
        window.pasteSlots = pasteSlots;
        function pasteSlots() {
            //get row data
            let row = document.getElementById(selected_row_id);
            let cells = row.children;
            let cellsAlt = row.querySelectorAll('td');

            //paste data from row into editable slots
            for (let i = 1; i <= 8; i++) {
                document.getElementById("slot" + i).innerHTML = cells[i - 1].textContent;
            }
        }





        //WIP - BUG_9
        window.addNewBookItem = addNewBookItem;
        function addNewBookItem() {

            alert("function doesn't work due to problems with isbn serialization, sorry!");
            return;

            ////checks data integrity
            //let n = document.getElementById("slot1").innerHTML;
            //let s = document.getElementById("slot2").innerHTML;
            //let b = document.getElementById("slot3").innerHTML;
            //let c = document.getElementById("slot4").innerHTML;
            //let e = document.getElementById("slot5").innerHTML;
            //
            //if (n === '' || s === '' || b === '' || c === '' || e === '') {
            //    alert("Must fill all slots first!");
            //    return;
            //}

            //create
            API.createOne("BookItem", {
                isbn: {value: "99999999999", __type: "BigInt"},
                remarks: String("remarks"),
                bookId: Number(1),
                locationId: Number(1),
                languageId: Number(1)
            }).then(response => { populate_book_items(); }).catch(err => {
                console.error("BookItem " + id + " creation failed", err);
                document.write("BookItem creation failed");
            });
        }

        window.modifySelectedBookItem = modifySelectedBookItem;
        function modifySelectedBookItem() {
            alert("function doesn't work due to problems with isbn serialization, sorry!");
            return;
        }



        ////COPY
        //window.modifySelectedStudent = modifySelectedStudent;
        //function modifySelectedStudent() {
        //
        //    //checks data integrity
        //    if (selected_row_id === '') {
        //        alert("You must first select the student to modify!");
        //        return;
        //    }
        //
        //    let n = document.getElementById("slot1").innerHTML;
        //    let s = document.getElementById("slot2").innerHTML;
        //    let b = document.getElementById("slot3").innerHTML;
        //    let c = document.getElementById("slot4").innerHTML;
        //    let e = document.getElementById("slot5").innerHTML;
        //
        //    if (n === '' || s === '' || b === '' || c === '' || e === '') {
        //        alert("Must fill all slots first!");
        //        return;
        //    }
        //
        //    let row = document.getElementById(selected_row_id);
        //    let cells = row.children;
        //    let cellsAlt = row.querySelectorAll('td');
        //    let id = cells[0].textContent;
        //
        //    if (cells[4].textContent != c) {
        //        alert("Class must stay the same!");
        //        return;
        //    }
        //
        //    //updates
        //    API.updateOne("Student", Number(id), {
        //        name: String(n),
        //        surname: String(s),
        //        birthDate: new Date(b),
        //        classId: Number(c),
        //        email: String(e),
        //        password: ""
        //    }).then(response => { populate_students(); }).catch(err => {
        //        console.error("Student " + id + " update failed", err);
        //        document.write("Student update failed");
        //    });
        //
        //}



        window.removeSelectedBookItem = removeSelectedBookItem;
        function removeSelectedBookItem() {

            alert("function doesn't work due to students having connections to other references, sorry!");

            //API.deleteOne("BookItem", 38).then(response => { populate_students(); });
        }


    </script>

</body>
</html>